openapi: 3.1.0
info:
  title: Collab Agent Backend API
  version: 1.0.0
  description: |
    Official REST API used by the Collab Agent VS Code extension.
    It covers authentication, users, Jira integration, AI features, Live Share telemetry, and profile management.

servers:
  - url: https://project-collabagent01.onrender.com
    description: Production
  - url: http://127.0.0.1:5000
    description: Local

security:
  - bearerAuth: []

paths:

  ############################################################
  # AUTHENTICATION
  ############################################################
  /auth/login:
    post:
      tags: ["Authentication"]
      summary: Email / password sign-in
      description: Sign-in using email credentials.
      parameters:
        - in: query
          name: provider
          required: true
          schema:
            type: string
            enum: ["email"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string, format: password }
      responses:
        200:
          description: Authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthToken"
        401:
          $ref: "#/components/responses/Unauthorized"

  /auth/signup:
    post:
      tags: ["Authentication"]
      summary: Create account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, first_name, last_name]
              properties:
                email:   { type: string, format: email }
                password: { type: string, format: password }
                first_name: { type: string }
                last_name: { type: string }
      responses:
        201:
          description: Account created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthToken"
        400:
          $ref: "#/components/responses/BadRequest"

  /auth/signout:
    post:
      tags: ["Authentication"]
      summary: Invalidate session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id]
              properties:
                user_id: { type: string }
      responses:
        204:
          description: Signed out
        400:
          $ref: "#/components/responses/BadRequest"

  ############################################################
  # USER MANAGEMENT
  ############################################################
  /users/{userId}/lock:
    put:
      tags: ["Users"]
      summary: Lock / unlock user
      parameters:
        - $ref: "#/components/parameters/UserId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id, is_locked]
              properties:
                user_id: { type: string }
                is_locked: { type: boolean }
      responses:
        200: { description: Status updated }
        400: { $ref: "#/components/responses/BadRequest" }

  /users/{userId}/status:
    put:
      tags: ["Users"]
      summary: Update overall user status
      parameters:
        - $ref: "#/components/parameters/UserId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  $ref: "#/components/schemas/UserStatus"
                userClassId:
                  type: string
                  nullable: true
      responses:
        200: { description: Updated }

  /users/{userId}:
    get:
      tags: ["Users"]
      summary: Get user by ID
      parameters:
        - $ref: "#/components/parameters/UserId"
      responses:
        200:
          description: User info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        404: { $ref: "#/components/responses/NotFound" }

  ############################################################
  # USER CLASS & SECTION MANAGEMENT
  ############################################################
  /users/{userId}/class-status:
    get:
      tags: ["Classes & Sections"]
      summary: Get per-class user status
      parameters:
        - $ref: "#/components/parameters/UserId"
        - in: query
          name: class_id
          schema: { type: string }
      responses:
        200:
          description: Class status
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/UserStatus"
        404:
          $ref: "#/components/responses/NotFound"

  /users/{userId}/sections:
    get:
      tags: ["Classes & Sections"]
      summary: Get section IDs for user
      parameters:
        - $ref: "#/components/parameters/UserId"
        - in: query
          name: class_id
          schema: { type: string }
      responses:
        200:
          description: Section info
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_section_id: { type: string }

    put:
      tags: ["Classes & Sections"]
      summary: Create / update section
      parameters:
        - $ref: "#/components/parameters/UserId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  $ref: "#/components/schemas/UserSectionStatus"
                userSectionId:
                  type: string
                  nullable: true
      responses:
        200: { description: Saved }

  /users/{userId}/classes:
    get:
      tags: ["Classes & Sections"]
      summary: List classes for user
      parameters:
        - $ref: "#/components/parameters/UserId"
      responses:
        200:
          description: Class list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UserClass"

  ############################################################
  # JIRA INTEGRATION
  ############################################################
  /api/jira/config:
    post:
      tags: ["Jira Integration"]
      summary: Save Jira integration (admin)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/JiraConfig"
      responses:
        200: { description: Saved }
        400: { $ref: "#/components/responses/BadRequest" }

  /api/jira/config/{teamId}:
    get:
      tags: ["Jira Integration"]
      summary: Get Jira config
      parameters:
        - $ref: "#/components/parameters/TeamId"
      responses:
        200:
          description: Config
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JiraConfig"
        404: { $ref: "#/components/responses/NotFound" }

    delete:
      tags: ["Jira Integration"]
      summary: Remove Jira config
      parameters:
        - $ref: "#/components/parameters/TeamId"
      responses:
        200: { description: Removed }

  ############################################################
  # AI FEATURES
  ############################################################
  /api/ai/feed:
    get:
      tags: ["AI Features"]
      summary: Team activity timeline
      parameters:
        - $ref: "#/components/parameters/TeamIdQuery"
        - in: query
          name: limit
          schema:
            type: integer
            default: 25
            minimum: 1
      responses:
        200:
          description: Activity list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ActivityItem"

  /api/ai/live_share_event:
    post:
      tags: ["AI Features"]
      summary: Insert Live Share event
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LiveShareEvent"
      responses:
        200: { description: Recorded }

  /api/ai/live_share_summary:
    post:
      tags: ["AI Features"]
      summary: Upload Live Share git diff / summary
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LiveShareSummary"
      responses:
        200:
          description: Snapshot stored
          content:
            application/json:
              schema:
                type: object
                properties:
                  snapshot_id: { type: string }

  /api/ai/task_recommendations:
    post:
      tags: ["AI Features"]
      summary: Generate AI task delegation suggestions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskRecommendationRequest"
      responses:
        200:
          description: Recommendations posted
          content:
            application/json:
              schema:
                type: object
                properties:
                  recommendations_count:
                    type: integer

  ############################################################
  # USER PROFILES
  ############################################################
  /api/profile:
    get:
      tags: ["User Profile"]
      summary: Fetch profile
      parameters:
        - in: query
          name: user_id
          required: true
          schema: { type: string }
      responses:
        200:
          description: Profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserProfile"
        404: { $ref: "#/components/responses/NotFound" }

    post:
      tags: ["User Profile"]
      summary: Create / update profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserProfile"
      responses:
        200: { description: Saved }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    UserId:
      name: userId
      in: path
      required: true
      schema: { type: string }
    TeamId:
      name: teamId
      in: path
      required: true
      schema: { type: string }
    TeamIdQuery:
      name: team_id
      in: query
      required: true
      schema: { type: string }

  responses:
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

  ########################################################
  # SCHEMAS (UNCHANGED FROM YOUR ORIGINAL)
  ########################################################
  schemas:
    AuthToken:
      type: object
      properties:
        token: { type: string }

    Error:
      type: object
      properties:
        error: { type: string }

    UserStatus:
      type: string
      enum: [ACTIVE, SUSPENDED, LOCKED]

    UserSectionStatus:
      type: string
      enum: [ACTIVE, NEED_REVIEW, COMPLETE]

    User:
      type: object
      properties:
        id: { type: string }
        email: { type: string, format: email }
        first_name: { type: string }
        last_name: { type: string }
        created_at: { type: string, format: date-time }
        userStatus:
          $ref: "#/components/schemas/UserStatus"
        role: { type: string }
        settings:
          $ref: "#/components/schemas/UserSettings"

    UserSettings:
      type: object
      properties:
        bug_percentage: { type: integer }
        show_notifications: { type: boolean }
        give_suggestions: { type: boolean }
        enable_quiz: { type: boolean }
        active_threshold: { type: integer }
        suspend_threshold: { type: integer }
        pass_rate: { type: integer }
        suspend_rate: { type: integer }

    UserClass:
      type: object
      properties:
        id: { type: string }
        classTitle: { type: string }
        classCode: { type: string }
        instructorId: { type: string }
        createdAt: { type: string, format: date-time }

    JiraConfig:
      type: object
      required: [team_id, jira_url, jira_project_key, access_token, admin_user_id]
      properties:
        team_id: { type: string }
        jira_url: { type: string, format: uri }
        jira_project_key: { type: string }
        access_token: { type: string }
        refresh_token: { type: string, nullable: true }
        admin_user_id: { type: string }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    ActivityItem:
      type: object
      properties:
        id: { type: string }
        team_id: { type: string }
        user_id: { type: string }
        summary: { type: string }
        activity_type: { type: string }
        file_path: { type: string }
        source_snapshot_id: { type: string }
        created_at: { type: string, format: date-time }
        display_name: { type: string }
        user_email: { type: string, format: email }

    LiveShareEvent:
      type: object
      required: [event_type, team_id, user_id, display_name]
      properties:
        event_type:
          type: string
          enum: [started, joined, ended]
        session_id: { type: string }
        team_id: { type: string }
        user_id: { type: string }
        display_name: { type: string }
        duration_minutes: { type: integer, nullable: true }
        snapshot_id: { type: string, nullable: true }

    LiveShareSummary:
      type: object
      required: [team_id, user_id, display_name, session_id, changes]
      properties:
        team_id: { type: string }
        user_id: { type: string }
        display_name: { type: string }
        session_id: { type: string }
        changes: { type: string }

    TaskRecommendationRequest:
      type: object
      required: [team_id, user_id, unassigned_tasks]
      properties:
        team_id: { type: string }
        user_id: { type: string }
        unassigned_tasks:
          type: array
          items:
            type: object
            required: [key, summary]
            properties:
              key: { type: string }
              summary: { type: string }
              description: { type: string }

    UserProfile:
      type: object
      required: [user_id]
      properties:
        user_id: { type: string }
        name: { type: string }
        interests:
          type: array
          items: { type: string }
        strengths:
          type: array
          items: { type: string }
        weaknesses:
          type: array
          items: { type: string }
        custom_skills:
          type: array
          items: { type: string }
