<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Collab Agent</title>
<link href="{{MAIN_STYLE_URI}}" rel="stylesheet" />
<link href="{{LIVESHARE_STYLE_URI}}" rel="stylesheet" />
<link href="{{AGENT_STYLE_URI}}" rel="stylesheet" />
</head>
<body>
<div class="tab-header">
    <button class="tab-btn" id="tab-home" data-tab="home">Home</button>
    <button class="tab-btn" id="tab-live" data-tab="live" title="">Live Share</button>
    <button class="tab-btn" id="tab-agent" data-tab="agent" title="">Agent Bot</button>
    <button class="tab-btn" id="tab-tasks" data-tab="tasks" title="">Tasks</button>
</div>
<div id="login-tooltip" class="login-tooltip" style="display: none;">Please log in first</div>
<div id="panel-home" class="tab-panel" style="display:block;">{{HOME_HTML}}</div>
<div id="panel-live" class="tab-panel">{{LIVESHARE_HTML}}</div>
<div id="panel-agent" class="tab-panel">{{AGENT_HTML}}</div>
<div id="panel-tasks" class="tab-panel">{{TASKS_HTML}}</div>
<script nonce="{{NONCE}}">
    // Initialize vscode API once for all scripts to use (make it global)
    window.vscode = acquireVsCodeApi();
</script>
<script nonce="{{NONCE}}" src="{{SCRIPT_URI}}"></script>
<script nonce="{{NONCE}}">
(function(){
    // vscode API already initialized above

    // Get auth state and Live Share install state from template replacement
    var authValue = '{{IS_AUTHENTICATED}}';
    var lsInstalledValue = '{{LIVESHARE_INSTALLED}}';
    let isAuthenticated = authValue === 'true';
    let liveShareInstalled = lsInstalledValue === 'true';

    function showTab(tab) {
        console.log('[MainPanel] Showing tab:', tab);
        document.getElementById('panel-home').style.display = tab==='home' ? 'block' : 'none';
        document.getElementById('panel-live').style.display = tab==='live' ? 'block' : 'none';
        document.getElementById('panel-agent').style.display = tab==='agent' ? 'block' : 'none';
        document.getElementById('panel-tasks').style.display = tab==='tasks' ? 'block' : 'none';
        document.getElementById('tab-home').classList.toggle('active', tab==='home');
        document.getElementById('tab-live').classList.toggle('active', tab==='live');
        document.getElementById('tab-agent').classList.toggle('active', tab==='agent');
        document.getElementById('tab-tasks').classList.toggle('active', tab==='tasks');

        // Save active tab to webview state for persistence
        vscode.setState({ activeTab: tab });
        console.log('[MainPanel] Saved active tab to state:', tab);

        // Notify extension that agent tab became visible (to refresh team info)
        if (tab === 'agent') {
            console.log('[MainPanel] Agent tab visible - requesting team info refresh');
            vscode.postMessage({ command: 'refreshTeams' });
        }

        // Notify extension that tasks tab became visible (to refresh tasks state)
        if (tab === 'tasks') {
            console.log('[MainPanel] Tasks tab visible - requesting tasks state refresh');
            vscode.postMessage({ command: 'tasksWebviewReady' });
        }
    }

    function showTooltip(element, message) {
        const tooltip = document.getElementById('login-tooltip');
        const rect = element.getBoundingClientRect();
        tooltip.textContent = message;
        tooltip.style.display = 'block';
        tooltip.style.left = rect.left + 'px';
        tooltip.style.top = (rect.bottom + 5) + 'px';
    }

    function hideTooltip() {
        document.getElementById('login-tooltip').style.display = 'none';
    }

    function handleTabClick(tab, element) {
        // Live Share tab additionally requires the Live Share extension
        if (tab === 'live' && !liveShareInstalled) {
            showTooltip(element, 'Live Share not installed. Click Home to install.');
            return;
        }
        // Live Share, Agent, and Tasks tabs require authentication
        if ((tab === 'live' || tab === 'agent' || tab === 'tasks') && !isAuthenticated) {
            showTooltip(element, 'Please log in first');
            return; // Don't switch tab if not authenticated
        }
        showTab(tab);
    }

    // Home tab - always accessible
    document.getElementById('tab-home').addEventListener('click', function(){
        showTab('home');
    });

    // Live Share tab - requires authentication
    const liveTab = document.getElementById('tab-live');
    liveTab.addEventListener('click', function(){
        handleTabClick('live', this);
    });
    liveTab.addEventListener('mouseenter', function() {
        if (!liveShareInstalled) {
            showTooltip(this, 'Live Share not installed. Click Home to install.');
            return;
        }
        if (!isAuthenticated) {
            showTooltip(this, 'Please log in first');
        }
    });
    liveTab.addEventListener('mouseleave', hideTooltip);

    // Agent Bot tab - requires authentication
    const agentTab = document.getElementById('tab-agent');
    agentTab.addEventListener('click', function(){
        handleTabClick('agent', this);
    });
    agentTab.addEventListener('mouseenter', function() {
        if (!isAuthenticated) {
            showTooltip(this, 'Please log in first');
        }
    });
    agentTab.addEventListener('mouseleave', hideTooltip);

    // Tasks tab - requires authentication
    const tasksTab = document.getElementById('tab-tasks');
    tasksTab.addEventListener('click', function(){
        handleTabClick('tasks', this);
    });
    tasksTab.addEventListener('mouseenter', function() {
        if (!isAuthenticated) {
            showTooltip(this, 'Please log in first');
        }
    });
    tasksTab.addEventListener('mouseleave', hideTooltip);

    // Restore previously active tab from state, or default to 'home'
    const previousState = vscode.getState();
    console.log('[MainPanel] Restored state:', previousState);
    const initialTab = (previousState && previousState.activeTab) ? previousState.activeTab : 'home';
    console.log('[MainPanel] Initial tab:', initialTab);

    // Only restore to agent/live tabs if authenticated and requirements met
    if (initialTab === 'agent' && !isAuthenticated) {
        console.log('[MainPanel] Cannot restore agent tab - not authenticated');
        showTab('home');
    } else if (initialTab === 'live' && (!isAuthenticated || !liveShareInstalled)) {
        console.log('[MainPanel] Cannot restore live tab - requirements not met');
        showTab('home');
    } else if (initialTab === 'tasks' && !isAuthenticated) {
        console.log('[MainPanel] Cannot restore tasks tab - not authenticated');
        showTab('home');
    } else {
        showTab(initialTab);
    }

    // Update authentication state when it changes
    window.updateAuthState = function(authenticated) {
        isAuthenticated = authenticated;
        // Update tab visual states
        const liveTab = document.getElementById('tab-live');
        const agentTab = document.getElementById('tab-agent');
        const tasksTab = document.getElementById('tab-tasks');
        if (authenticated) {
            agentTab.classList.remove('disabled');
            tasksTab.classList.remove('disabled');
            if (liveShareInstalled) {
                liveTab.classList.remove('disabled');
            } else {
                liveTab.classList.add('disabled');
            }
        } else {
            liveTab.classList.add('disabled');
            agentTab.classList.add('disabled');
            tasksTab.classList.add('disabled');
        }
    };

    // Listen for auth state updates from extension
    window.addEventListener('message', function(event) {
        const message = event.data;
        if (message.command === 'updateAuthState') {
            window.updateAuthState(message.authenticated);
        }
    });

    // Set initial disabled state
    if (!isAuthenticated) {
        document.getElementById('tab-agent').classList.add('disabled');
        document.getElementById('tab-tasks').classList.add('disabled');
    }
    if (!isAuthenticated || !liveShareInstalled) {
        document.getElementById('tab-live').classList.add('disabled');
    }
})();
</script>
</body>
</html>
