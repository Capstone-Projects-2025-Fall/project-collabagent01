<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Collab Agent</title>
<link href="{{MAIN_STYLE_URI}}" rel="stylesheet" />
<link href="{{LIVESHARE_STYLE_URI}}" rel="stylesheet" />
<link href="{{AGENT_STYLE_URI}}" rel="stylesheet" />
</head>
<body>
<div class="tab-header">
    <button class="tab-btn" id="tab-home" data-tab="home">Home</button>
    <button class="tab-btn" id="tab-live" data-tab="live" title="">Live Share</button>
    <button class="tab-btn" id="tab-agent" data-tab="agent" title="">Agent Bot</button>
</div>
<div id="login-tooltip" class="login-tooltip" style="display: none;">Please log in first</div>
<div id="panel-home" class="tab-panel" style="display:block;">{{HOME_HTML}}</div>
<div id="panel-live" class="tab-panel">{{LIVESHARE_HTML}}</div>
<div id="panel-agent" class="tab-panel">{{AGENT_HTML}}</div>
<script nonce="{{NONCE}}" src="{{SCRIPT_URI}}"></script>
<script nonce="{{NONCE}}">
(function(){
    // Get auth state from template replacement
    var authValue = '{{IS_AUTHENTICATED}}';
    let isAuthenticated = authValue === 'true';
    
    function showTab(tab) {
        document.getElementById('panel-home').style.display = tab==='home' ? 'block' : 'none';
        document.getElementById('panel-live').style.display = tab==='live' ? 'block' : 'none';
        document.getElementById('panel-agent').style.display = tab==='agent' ? 'block' : 'none';
        document.getElementById('tab-home').classList.toggle('active', tab==='home');
        document.getElementById('tab-live').classList.toggle('active', tab==='live');
        document.getElementById('tab-agent').classList.toggle('active', tab==='agent');
    }
    
    function showTooltip(element, message) {
        const tooltip = document.getElementById('login-tooltip');
        const rect = element.getBoundingClientRect();
        tooltip.textContent = message;
        tooltip.style.display = 'block';
        tooltip.style.left = rect.left + 'px';
        tooltip.style.top = (rect.bottom + 5) + 'px';
    }
    
    function hideTooltip() {
        document.getElementById('login-tooltip').style.display = 'none';
    }
    
    function handleTabClick(tab, element) {
        if ((tab === 'live' || tab === 'agent') && !isAuthenticated) {
            return; // Don't switch tab if not authenticated
        }
        showTab(tab);
    }
    
    // Home tab - always accessible
    document.getElementById('tab-home').addEventListener('click', function(){ 
        showTab('home'); 
    });
    
    // Live Share tab - requires authentication
    const liveTab = document.getElementById('tab-live');
    liveTab.addEventListener('click', function(){ 
        handleTabClick('live', this); 
    });
    liveTab.addEventListener('mouseenter', function() {
        if (!isAuthenticated) {
            showTooltip(this, 'Please log in first');
        }
    });
    liveTab.addEventListener('mouseleave', hideTooltip);
    
    // Agent Bot tab - requires authentication  
    const agentTab = document.getElementById('tab-agent');
    agentTab.addEventListener('click', function(){ 
        handleTabClick('agent', this); 
    });
    agentTab.addEventListener('mouseenter', function() {
        if (!isAuthenticated) {
            showTooltip(this, 'Please login first');
        }
    });
    agentTab.addEventListener('mouseleave', hideTooltip);
    
    showTab('home');
    
    // Update authentication state when it changes
    window.updateAuthState = function(authenticated) {
        isAuthenticated = authenticated;
        // Update tab visual states
        const liveTab = document.getElementById('tab-live');
        const agentTab = document.getElementById('tab-agent');
        if (authenticated) {
            liveTab.classList.remove('disabled');
            agentTab.classList.remove('disabled');
        } else {
            liveTab.classList.add('disabled');
            agentTab.classList.add('disabled');
        }
    };
    
    // Listen for auth state updates from extension
    window.addEventListener('message', function(event) {
        const message = event.data;
        if (message.command === 'updateAuthState') {
            window.updateAuthState(message.authenticated);
        }
    });
    
    // Set initial disabled state for non-authenticated users
    if (!isAuthenticated) {
        document.getElementById('tab-live').classList.add('disabled');
        document.getElementById('tab-agent').classList.add('disabled');
    }
})();
</script>
</body>
</html>